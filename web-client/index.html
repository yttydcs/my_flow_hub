<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MyFlowHub Proto 客户端</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; }
      header { background: #111827; color: #fff; padding: 12px 16px; }
      main { padding: 16px; display: grid; grid-template-columns: 340px 1fr; gap: 16px; align-items: start; }
      fieldset { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; }
      legend { font-weight: 600; letter-spacing: .5px; }
      label { display: block; margin-top: 8px; font-size: 12px; color: #374151; }
      input, button { margin-top: 4px; padding: 8px; font-size: 14px; }
      .row { display: flex; gap: 8px; }
      .row > * { flex: 1; }
      #log { height: 64vh; overflow: auto; background: #0b1020; color: #d1d5db; padding: 10px; border-radius: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
      .log-item { margin-bottom: 10px; border-bottom: 1px dashed #1f2937; padding-bottom: 8px; }
      .tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 6px; background: #374151; color: #e5e7eb; }
    </style>
  </head>
  <body>
    <header><h1>MyFlowHub Web Proto Client</h1></header>
    <main>
      <section>
        <fieldset>
          <legend>连接</legend>
          <label>WebSocket 地址</label>
          <input id="wsUrl" value="ws://127.0.0.1:18080/ws" />
          <div class="row">
            <button id="btnConnect">连接</button>
            <button id="btnDisconnect" disabled>断开</button>
          </div>
          <label>Manager Token</label>
          <input id="token" placeholder="manager/config.json 中的 token" />
          <div class="row">
            <button id="btnManagerAuth" disabled>发送 ManagerAuth</button>
          </div>
        </fieldset>
        <fieldset style="margin-top:12px">
          <legend>ParentAuth 调试</legend>
          <label>Relay/Shared Token（用于 HMAC）</label>
          <input id="relayToken" placeholder="server/config.json 的 relayToken（或回退 managerToken）" />
          <label>Hardware ID</label>
          <input id="hardwareId" placeholder="设备硬件ID，例如 device-001" />
          <label>Caps</label>
          <input id="caps" placeholder="能力标记，如 relay|sensor，可留空" />
          <div class="row">
            <button id="btnParentAuth" disabled>发送 ParentAuth</button>
          </div>
        </fieldset>
        <fieldset style="margin-top:12px">
          <legend>消息发送（MSG_SEND）</legend>
          <label>目标 Target UID（0=广播）</label>
          <input id="targetUid" placeholder="输入设备UID，0 表示广播" />
          <label>载荷 Payload</label>
          <textarea id="payload" rows="4" placeholder="文本或十六进制"></textarea>
          <div class="row">
            <select id="payloadMode">
              <option value="text">文本(UTF-8)</option>
              <option value="hex">十六进制(如: 01 0a ff)</option>
            </select>
            <button id="btnSend">发送到目标</button>
            <button id="btnBroadcast">广播发送</button>
          </div>
          <div style="margin-top:6px; font-size:12px; opacity:.8">当前连接设备UID：<span id="selfUid">(未知，需先认证)</span></div>
        </fieldset>
      </section>
      <section>
        <fieldset>
          <legend>日志</legend>
          <div id="log"></div>
        </fieldset>
      </section>
    </main>

    <!-- protobufjs UMD -->
    <script src="https://unpkg.com/protobufjs/dist/protobuf.min.js"></script>
    <script type="module">
      import { Type, encodeFrame, decodeFrame, nextMsgID, decodeProtobufPayload, encodeManagerAuthReq, encodeParentAuthReq } from './protocol.js?v=3'

      const wsUrl = document.getElementById('wsUrl')
      const token = document.getElementById('token')
  const btnConnect = document.getElementById('btnConnect')
      const btnDisconnect = document.getElementById('btnDisconnect')
      const btnManagerAuth = document.getElementById('btnManagerAuth')
  const relayToken = document.getElementById('relayToken')
  const hardwareId = document.getElementById('hardwareId')
  const caps = document.getElementById('caps')
  const btnParentAuth = document.getElementById('btnParentAuth')
      const logEl = document.getElementById('log')
      const targetUid = document.getElementById('targetUid')
      const payload = document.getElementById('payload')
      const payloadMode = document.getElementById('payloadMode')
      const btnSend = document.getElementById('btnSend')
      const btnBroadcast = document.getElementById('btnBroadcast')
      const selfUidEl = document.getElementById('selfUid')

      let ws = null
      let currentDeviceUID = 0n

      function log(kind, text, obj) {
        const div = document.createElement('div')
        div.className = 'log-item'
        const tag = document.createElement('span')
        tag.className = 'tag'
        tag.textContent = kind
        const pre = document.createElement('pre')
        pre.textContent = text + (obj ? '\n' + JSON.stringify(obj, null, 2) : '')
        div.appendChild(tag)
        div.appendChild(pre)
        logEl.appendChild(div)
        logEl.scrollTop = logEl.scrollHeight
      }

      function setConnected(on) {
        btnConnect.disabled = on
        btnDisconnect.disabled = !on
        btnManagerAuth.disabled = !on
        btnParentAuth.disabled = !on
      }

      btnConnect.addEventListener('click', () => {
        if (ws) return
        const url = wsUrl.value.trim()
        ws = new WebSocket(url, 'myflowhub.bin.v1')
        ws.binaryType = 'arraybuffer'
        ws.onopen = () => { log('INFO', 'connected: ' + url); setConnected(true) }
        ws.onclose = () => { log('INFO', 'closed'); setConnected(false); ws = null }
        ws.onerror = () => { log('ERR', 'socket error') }
        ws.onmessage = (ev) => {
          if (!(ev.data instanceof ArrayBuffer)) { log('WARN', 'non-binary frame'); return }
          const { header, payload } = decodeFrame(ev.data)
          // 辅助：打印收到的头部原始字段
          log('INFO', `RECV-HEADER type=${header.typeID} msgID=${header.msgID} src=${header.source} tgt=${header.target} ts=${header.timestamp}`)
          const obj = decodeProtobufPayload(header.typeID, payload)
          // 若无法以 protobuf 解码，展示十六进制与 UTF-8 预览
          let extra = null
          if (!obj && payload && payload.byteLength) {
            const u8 = new Uint8Array(payload)
            const hex = [...u8].map(b => b.toString(16).padStart(2,'0')).join(' ')
            let text = ''
            try { text = new TextDecoder().decode(u8) } catch {}
            extra = { hex, text }
          }
          // 解码 OK/ERR 的 message（protobufjs bytes->String 为 base64）
          let displayObj = obj || extra
          if (obj && (header.typeID === Type.OK_RESP || header.typeID === Type.ERR_RESP) && typeof obj.message === 'string') {
            try {
              const b64 = obj.message
              const bin = atob(b64)
              const arr = new Uint8Array(bin.length)
              for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i)
              const decoded = new TextDecoder().decode(arr)
              displayObj = { ...obj, message: decoded }
            } catch {}
          }
          log('RECV', `type=${header.typeID} msgID=${header.msgID} src=${header.source} tgt=${header.target} ts=${header.timestamp}`, displayObj)

          // 捕获自身 UID（来自 ManagerAuthResp 或 ParentAuthResp）
          if (header.typeID === Type.MANAGER_AUTH_RESP && obj && obj.device_uid) {
            try { currentDeviceUID = BigInt(obj.device_uid) } catch { currentDeviceUID = 0n }
            selfUidEl.textContent = currentDeviceUID.toString()
          }
          if (header.typeID === Type.PARENT_AUTH_RESP && obj && obj.device_uid) {
            try { currentDeviceUID = BigInt(obj.device_uid) } catch { currentDeviceUID = 0n }
            selfUidEl.textContent = currentDeviceUID.toString()
          }
        }
      })

      btnDisconnect.addEventListener('click', () => { if (ws) ws.close() })

      btnManagerAuth.addEventListener('click', () => {
        try {
          if (!ws) { log('WARN', '尚未连接'); return }
          const t = token.value.trim()
          if (!t) { log('WARN', '请输入 token'); return }
          const msgID = nextMsgID()
          log('INFO', `准备发送 ManagerAuth (msgID=${msgID})`)
          const payload = encodeManagerAuthReq(t)
          const frame = encodeFrame(Type.MANAGER_AUTH_REQ, msgID, 0n, 0n, payload)
          ws.send(frame)
          log('SEND', `ManagerAuthReq (msgID=${msgID})`)
        } catch (e) {
          log('ERR', 'ManagerAuth 发送失败', { error: String(e) })
        }
      })

      function parseHexToBytes(str) {
        const clean = str.replace(/[^0-9a-fA-F]/g, ' ')
        const parts = clean.trim().split(/\s+/).filter(Boolean)
        const out = new Uint8Array(parts.length)
        for (let i = 0; i < parts.length; i++) out[i] = parseInt(parts[i], 16) & 0xff
        return out
      }

      function buildPayload() {
        const mode = payloadMode.value
        const text = payload.value || ''
        if (mode === 'hex') return parseHexToBytes(text)
        return new TextEncoder().encode(text)
      }

      function parseTarget(input) {
        const s = (input || '').trim()
        if (!s) return 0n
        try { return BigInt(s) } catch { return 0n }
      }

      function sendMsg(toUIDBigInt) {
        if (!ws) { log('WARN', '未连接'); return }
        const msgID = nextMsgID()
        const src = currentDeviceUID || 0n
        const pl = buildPayload()
        const frame = encodeFrame(Type.MSG_SEND, msgID, src, toUIDBigInt, pl)
        // 本地校验：打印前 38 字节十六进制，确认 TypeID=0a 00 开头
        try {
          const h = new Uint8Array(frame).slice(0, 38)
          const hex = [...h].map(b => b.toString(16).padStart(2,'0')).join(' ')
          log('INFO', 'LOCAL-HEADER-HEX ' + hex)
        } catch {}
        ws.send(frame)
        log('INFO', `SEND-HEADER type=${Type.MSG_SEND} msgID=${msgID} src=${src} tgt=${toUIDBigInt} ts=${Date.now()}`)
        log('SEND', `MSG_SEND (msgID=${msgID}) src=${src} tgt=${toUIDBigInt} bytes=${pl.length}`)
      }

      btnSend.addEventListener('click', () => {
        const tgt = parseTarget(targetUid.value)
        if (tgt === 0n) { log('WARN', '目标为0等同广播，请使用“广播发送”按钮'); return }
        sendMsg(tgt)
      })

      btnBroadcast.addEventListener('click', () => {
        sendMsg(0n)
      })

      // --- ParentAuth flow ---
      async function hmacSha256(keyBytes, ...parts) {
        const cryptoKey = await window.crypto.subtle.importKey(
          'raw', keyBytes, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
        )
        // concat parts
        let total = 0
        for (const p of parts) total += p.byteLength
        const all = new Uint8Array(total)
        let off = 0
        for (const p of parts) { all.set(new Uint8Array(p), off); off += p.byteLength }
        const sig = await window.crypto.subtle.sign('HMAC', cryptoKey, all)
        return new Uint8Array(sig)
      }

      function u64le(nBig) {
        const buf = new ArrayBuffer(8)
        new DataView(buf).setBigUint64(0, BigInt(nBig), true)
        return buf
      }
      function randomNonce16() {
        const a = new Uint8Array(16)
        window.crypto.getRandomValues(a)
        return a
      }

      btnParentAuth.addEventListener('click', async () => {
        try {
          if (!ws) { log('WARN', '尚未连接'); return }
          const k = relayToken.value.trim()
          const hid = hardwareId.value.trim()
          const cp = caps.value.trim()
          if (!k || !hid) { log('WARN', '请输入 Relay/Shared Token 与 HardwareID'); return }
          const tsMs = Date.now()
          const nonce = randomNonce16()
          log('INFO', `准备发送 ParentAuth ts=${tsMs} hw=${hid}`)
          const sig = await hmacSha256(new TextEncoder().encode(k), u64le(BigInt(tsMs)), nonce, new TextEncoder().encode(hid), new TextEncoder().encode(cp))
          const msgID = nextMsgID()
          const payload = encodeParentAuthReq({ version: 1, tsMs, nonce, hardwareId: hid, caps: cp, sig })
          const frame = encodeFrame(Type.PARENT_AUTH_REQ, msgID, 0n, 0n, payload)
          ws.send(frame)
          log('SEND', `ParentAuthReq (msgID=${msgID})`)
        } catch (e) {
          log('ERR', 'ParentAuth 发送失败', { error: String(e) })
        }
      })
    </script>
  </body>
</html>
