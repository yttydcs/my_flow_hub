# MyFlowHub

MyFlowHub 是一个为物联网（IoT）和分布式系统设计的、轻量级的、层级化的消息与数据同步系统。

## 设计理念

项目的核心是构建一个抽象网络，其中所有设备（从云端服务器到嵌入式节点）都是平等的“节点”，可以相互通信。

- **统一服务端**: 系统中的“中枢（Hub）”和“中继（Relay）”是同一种服务端软件的不同配置实例。一个没有上级的服务端即为中枢，有上级的则为中继。
- **持久化身份**: 每个节点（包括中枢和中继）在首次启动时都会在数据库中注册自己，获得一个唯一的、持久化的数字ID。
- **分层路由**: 消息可以在网络中向上（向父节点）或向下（向子节点）传递，实现了高效、可扩展的路由。
- **双向数据绑定**: 以“变量池”为核心，实现了设备状态与云端数据的实时、双向同步。

## 期望功能与实现状态

| 功能点 | 状态 | 备注 |
| :--- | :--- | :--- |
| **核心网络** | | |
| 统一服务端（中枢/中继） | ✅ 已实现 | 通过 `config.json` 配置。 |
| 服务端自举注册 | ✅ 已实现 | 服务器启动时会在数据库中为自己创建持久化身份。 |
| 节点动态注册与认证 | ✅ 已实现 | 客户端可通过 `hardwareId` 注册并获取数字ID和密钥。 |
| 客户端身份持久化 | ✅ 已实现 | Web客户端使用 `localStorage`。 |
| 并发安全的连接管理 | ✅ 已实现 | 采用 Hub-and-Spoke 模型，保证并发安全。 |
| 分层消息路由 | ✅ 已实现 | 支持点对点、广播和向上传递。 |
| **变量池** | | |
| 变量更新 | ✅ 已实现 | 支持跨命名空间更新。 |
| 变量查询 | ✅ 已实现 | 支持按名称或ID进行高级批量查询。 |
| 变量名合法性验证 | ✅ 已实现 | 限制为汉字、字母、数字、下划线。 |
| **双向绑定** | | |
| 下行通知（变量变更） | ✅ 已实现 | 变量被修改后，会主动通知在线的所属节点。 |
| 上线状态同步 | ✅ 已实现 | 节点认证成功后，会收到其变量池的完整初始状态。 |
| **管理后台** | | |
| BFF 架构 | ✅ 已实现 | `manager` 服务作为前端的后端。 |
| 特权节点认证 | ✅ 已实现 | `manager` 节点使用 Token 进行注册。 |
| **工具** | | |
| Web GUI 调试客户端 | ✅ 已实现 | `web-client/` 目录下的独立HTML文件。 |
| **其他** | | |
| 外部化配置 | ✅ 已实现 | 所有关键配置均在 `config.json` 中。 |
| 权限管理 | ❌ 未实现 | 当前默认允许所有操作。 |
| 二进制协议支持 | ❌ 未实现 | 当前使用JSON，未来可优化。 |

## 项目结构

-   **`server/`**: Go 核心消息服务端。
    -   `cmd/myflowhub/main.go`: `main` 包，程序入口。
    -   `internal/`: 核心逻辑。
        -   `config/`: 配置加载。
        -   `database/`: 数据库模型和初始化。
        -   `hub/`: WebSocket 中心和消息路由逻辑。
    -   `pkg/`: 可共享的包。
        -   `protocol/`: 定义通信协议的 Go 结构体。
-   **`manager/`**: Go 后台管理服务 (BFF)。
    -   `cmd/manager/main.go`: `main` 包，程序入口。
-   **`web/`**: Vue 3 前端管理界面。
-   **`web-client/`**: 用于快速调试的、独立的 HTML 客户端。

## 如何运行

1.  **配置**:
    *   打开 `server/config.json`。
    *   在 `Database` 部分，将 `Password` 修改为您本地 PostgreSQL 的真实密码。
    *   （可选）在 `Relay` 部分，将 `Enabled` 设置为 `true` 来启动一个中继实例。
2.  **启动核心服务**:
    ```bash
    cd server
    go run ./cmd/myflowhub
    ```
3.  **启动管理后台服务**:
    *   打开一个新的终端。
    ```bash
    cd manager
    go run ./cmd/manager
    ```
4.  **开发前端**:
    *   打开一个新的终端。
    ```bash
    cd web
    npm install
    npm run dev
    ```
5.  **访问**:
    *   **管理后台**: 在浏览器中打开 `http://localhost:5173` (Vite 开发服务器的默认地址)。
    *   **调试客户端**: 在文件浏览器中打开 `web-client/index.html`。

## 下一步计划

1.  **实现 Manager API**: 在 `manager` 服务中，实现连接到核心服务、获取数据并向前端提供 API 的逻辑。
2.  **构建前端界面**: 在 `web` 项目中，使用 Naive UI 组件构建一个可以展示节点树、查看和修改变量的完整管理界面。
3.  **实现权限系统**: 基于 `access_permissions` 表，为变量的读写和消息的发送实现完整的权限检查逻辑。
