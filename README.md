# MyFlowHub

MyFlowHub 是一个为物联网（IoT）和分布式系统设计的、轻量级的、层级化的消息与数据同步系统。

## 设计理念

项目的核心是构建一个抽象网络，其中所有设备（从云端服务器到嵌入式节点）都是平等的“节点”，可以相互通信。

- **统一服务端**: 系统中的“中枢（Hub）”和“中继（Relay）”是同一种服务端软件的不同配置实例。一个没有上级的服务端即为中枢，有上级的则为中继。
- **持久化身份**: 每个节点（包括中枢和中继）在首次启动时都会在数据库中注册自己，获得一个唯一的、持久化的数字ID。
- **分层路由**: 消息可以在网络中向上（向父节点）或向下（向子节点）传递，实现了高效、可扩展的路由。
- **双向数据绑定**: 以“变量池”为核心，实现了设备状态与云端数据的实时、双向同步。

## 期望功能与实现状态

| 功能点 | 状态 | 备注 |
| :--- | :--- | :--- |
| **核心网络** | | |
| 统一服务端（中枢/中继） | ✅ 已实现 | 通过有无上级配置来区分角色。 |
| 服务端自举注册 | ✅ 已实现 | 服务器启动时会在数据库中为自己创建持久化身份。 |
| 节点动态注册与认证 | ✅ 已实现 | 客户端可通过 `hardwareId` 注册并获取数字ID和密钥。 |
| 客户端身份持久化 | ✅ 已实现 | Web客户端使用 `localStorage`，中继使用临时文件。 |
| 并发安全的连接管理 | ✅ 已实现 | 采用 Hub-and-Spoke 模型，保证并发安全。 |
| 分层消息路由 | ✅ 已实现 | 支持点对点、广播和向上传递。 |
| **变量池** | | |
| 变量更新 | ✅ 已实现 | 支持跨命名空间更新。 |
| 变量查询 | ✅ 已实现 | 支持按名称或ID进行高级批量查询。 |
| 变量名合法性验证 | ✅ 已实现 | 限制为汉字、字母、数字、下划线。 |
| **双向绑定** | | |
| 下行通知（变量变更） | ✅ 已实现 | 变量被修改后，会主动通知在线的所属节点。 |
| 上线状态同步 | ✅ 已实现 | 节点认证成功后，会收到其变量池的完整初始状态。 |
| **工具** | | |
| Web GUI 调试客户端 | ✅ 已实现 | 功能全面的Web界面，用于测试所有核心功能。 |
| **其他** | | |
| 外部化配置 | ⏳ **下一步** | 将数据库连接等信息移至配置文件。 |
| 权限管理 | ❌ 未实现 | 当前默认允许所有操作。 |
| 二进制协议支持 | ❌ 未实现 | 当前使用JSON，未来可优化。 |

## 如何运行

1.  **准备环境**:
    *   确保您的系统中已安装 Go 和 PostgreSQL。
    *   在 `poc/server/main.go` 中，将 `dbPassword` 的值修改为您本地 PostgreSQL 的真实密码。
2.  **启动中枢**:
    ```bash
    cd poc/server
    go run .
    ```
3.  **（可选）启动中继**:
    *   打开一个新的终端。
    ```bash
    cd poc/server
    go run . relay
    ```
4.  **打开调试客户端**:
    *   在您的文件浏览器中，找到 `web-client/index.html` 并用浏览器打开。
    *   您可以打开多个客户端窗口来模拟多个设备。

## 下一步计划

1.  **完善配置管理**: 将所有硬编码的配置（如数据库DSN、监听地址等）移动到外部配置文件中（例如 `config.json` 或环境变量）。
2.  **实现权限系统**: 基于 `access_permissions` 表，为变量的读写和消息的发送实现完整的权限检查逻辑。
3.  **优化数据模型**: 为变量增加时间戳和版本号，以处理并发更新和实现更复杂的同步策略。
4.  **二进制协议**: 设计并实现基于 Protocol Buffers 或类似技术的二进制通信协议，以大幅降低带宽占用。
