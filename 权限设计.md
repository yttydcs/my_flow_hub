# 权限系统设计文档

本文档为 MyFlowHub 的完整权限管理方案，覆盖认证/授权模型、权限节点语法、所有权与管理员标记、密钥机制、API 设计、前端显示约束、数据模型与迁移计划，并逐条映射需求清单。

## 1. 目标与范围

- 统一认证与授权：所有 Server/Manager/WS/REST 请求经统一鉴权中间件判定。
- 显式权限 + 隐式权限：权限节点以“允许”为主，叠加设备所有权与管理员标记产生的隐式权限。
- 委托与撤销：支持用户生成可限时/限次的密钥，下发到设备或用于会话；可随时撤销。
- 分层设备友好：默认设备可访问自身及子树设备的变量池。
- 通配符授权：权限节点支持精细到变量名，也支持范围授权。

## 2. 核心概念

- 主体(Subject)：执行操作的实体，分为用户(User)、设备(Device)、密钥(Key)。
- 资源(Resource)：设备(Device)、变量(Variable)等。
- 动作(Action)：read/update/add/remove 等。
- 权限节点(Permission Node)：以点分段的字符串，描述“对资源执行某动作”的授权，支持通配符。
- 所有权(Ownership)：设备的 owner_user_id 指向用户，带来隐式管理权与变量权限。
- 管理员标记(Admin Flag)：授予用户“管理员角色”的标识，隐式注入一组管理权限。

## 3. 权限节点语法

- 结构：`category.action.[resourceSegments...]`
- 示例：
	- `var.read.[deviceId].[varName]`
	- `var.update.[deviceId].[varName]`
	- `var.remove.[deviceId].[varName]`
	- `var.add.[deviceId].[varName]`
	- `device.remove.[deviceId]`
	- `admin.add`、`admin.remove`
	- `admin.manage`：具备“实际的管理员权限”，如“获取所有设备”等全局管理能力的总开关。
- 通配符：
	- `*` 匹配单个段；`**` 匹配零个或多个剩余段（仅用于末尾或独段）。
	- 例：`var.read.123.*` 读取设备 123 的全部变量；`var.update.**` 更新任意设备任意变量。

匹配规则：
1) 将本次操作映射为所需节点（如读取设备 9 的变量 name -> `var.read.9.name`）。
2) 在主体的“有效权限集合”中，存在任一允许节点能匹配（含通配符）即通过。
3) 采用“默认拒绝，无显式拒绝(deny)”策略；冲突时“允许任一即允许”。

## 4. 主体与隐式权限

### 4.1 用户(User)
- 可绑定显式权限节点；可被授予管理员标记；可拥有设备。
- 拥有设备所有权时，获得对该设备及其子树的“所有者策略(OwnerPolicy)”隐式权限：
	- 变量：`var.read/update/add/remove.[deviceId or subtree].*`
	- 设备管理：`device.update/remove/assignOwner.[deviceId or subtree]`
	- 借用权限：可为该范围内资源向他人授予子集权限或发放密钥。

### 4.2 设备(Device)
- 默认获得对“自身及子设备”的变量池访问隐式权限(DeviceSelfPolicy)：
	- `var.read/update/add/remove.[self and subtree].*`
	- 不含全局管理动作（如用户管理、任意设备删除）。

### 4.3 管理员标记(Admin Flag)与 admin.manage
- 为用户授予“管理员标记”后，隐式注入“系统管理员策略(SystemAdminPolicy)”。
- 该策略至少包含：
	- `admin.manage`（全局管理开关——无此节点不得进行任何全局管理，如“获取全部设备”、“遍历所有用户/日志”等）。
	- `admin.add`、`admin.remove`（授予或移除他人的管理员标记）。
	- 用户管理：`user.create`、`user.read`、`user.update.*`、`user.remove.*`
	- 设备全局管理：`device.add`、`device.update.*`、`device.remove.*`、`device.assignOwner.*`
	- 变量全局管理：`var.read.**`、`var.update.**`、`var.add.**`、`var.remove.**`
	- 密钥与授予：`key.create`、`key.read.*`、`key.revoke.*`、`grant.create`、`grant.revoke.*`
	- 日志与审计：`log.read`
- 建议将管理端关键操作在服务端统一要求 `admin.manage` + 具体节点，例如：
	- 列出所有设备：需要 `admin.manage` 与 `device.readAll`（或用 `device.read.*`）。
	- 列出所有用户：需要 `admin.manage` 与 `user.read`。

## 5. 密钥(Key)体系

用途：权限委托与会话凭证，可绑定到用户或设备，承载权限节点集合，可限时/限次，可撤销。

字段与约束：
- 绑定主体：`bind_subject_type` ∈ {user, device}（可空表示通用会话密钥），`bind_subject_id`
- 权限集合：`nodes[]`（必须是签发者“当前有效权限”的子集）
- 过期时间：`expires_at`
- 使用次数：`max_uses`、`remaining_uses`（在“鉴权成功”时扣减）
- 撤销：`revoked = true` 即刻失效

下发流程：
1) 用户生成密钥（指定节点集合/到期/次数/是否绑定设备）。
2) 下发到设备：设备保存密钥或使用一次性交换码由 Server 绑定；随即该设备有效权限 = 设备隐式权限 ∪ 密钥权限。
3) Manager 登录（见 §9）：Server 以密钥作为会话令牌，承载用户权限。

## 6. 统一鉴权流程

1) 认证(AuthN)：解析请求来源（用户登录会话密钥、设备凭证、附带密钥），校验签名/哈希、过期、撤销、剩余次数；并发下采用行级锁或乐观锁扣减 `remaining_uses`。
2) 聚合权限：
	 - 显式权限：主体(user/device)的节点 ∪ 附带密钥的节点 ∪ 用户间借用授权(grant)的节点。
	 - 隐式权限：OwnerPolicy / DeviceSelfPolicy / SystemAdminPolicy。
3) 匹配：将当前操作映射为所需节点；通配符匹配命中即允许，否则拒绝。
4) 审计：记录关键操作（签发/撤销密钥、管理员标记变更、删除设备/变量等）。

## 7. 数据模型（新增/变更）

- users(id, username, password_hash, display_name, created_at, disabled)
- devices(id, parent_id, hardware_id, name, owner_user_id, ...existing)
- permissions(id, subject_type ENUM('user','device','key'), subject_id, node, created_by, created_at)
- keys(id, owner_user_id, bind_subject_type NULL|'device'|'user', bind_subject_id, secret_hash, expires_at, max_uses, remaining_uses, revoked, issued_by, issued_at, meta)
- grants(id, grantor_user_id, grantee_user_id, scope_nodes JSON, expires_at, revoked, created_at)
- audit_logs(id, subject_type, subject_id, action, resource, decision, ip, ua, at, extra)

索引建议：
- permissions(subject_type, subject_id)
- keys(bind_subject_type, bind_subject_id, revoked, expires_at)
- devices(parent_id), devices(owner_user_id)
- audit_logs(at)

## 8. API 设计（Server 暴露，Manager 代理）

说明：括号内为服务端要求的权限节点；若带“全局”语义还需 `admin.manage`。

### 8.1 用户 CRUD（全局仅管理员可见）
- POST /users（user.create + admin.manage）
- GET /users（user.read + admin.manage）
- PUT /users/{id}（user.update.{id} + admin.manage 或拥有者自改需另行定义）
- DELETE /users/{id}（user.remove.{id} + admin.manage）
- POST /users/{id}/admin-flag（admin.add + admin.manage）
- DELETE /users/{id}/admin-flag（admin.remove + admin.manage）

### 8.2 设备
- POST /devices?ownerCode=...（device.add；若给定 ownerCode -> 设 owner_user_id）
- PUT /devices/{id}（device.update.{id} 或 OwnerPolicy 隐式允许）
- DELETE /devices/{id}（device.remove.{id} 或 OwnerPolicy 隐式允许）
- PUT /devices/{id}/owner（device.assignOwner.{id} 或 OwnerPolicy 隐式允许）
- GET /devices（列表）：
	- 管理员：需要 `admin.manage` + `device.read.*`（或 `device.readAll`）。
	- 普通用户：仅返回 `owner_user_id=自己` 的设备树。

约束与请求字段（实现约定）
- 创建设备（POST /devices）：
	- 请求字段：`HardwareID`、`Name`、`Role`、`ParentID`、`OwnerUserID?`。
	- 管理员（含 `admin.manage`）可自由创建；可为任意用户设为 `OwnerUserID`。
	- 非管理员：
		- 必须提供 `ParentID`，且对该父设备具备控制权（设备默认自控/祖先，或作为所有者）。
		- 不得将 `OwnerUserID` 设为他人；若未提供该字段，服务端会默认将 `OwnerUserID` 设为当前用户。
		- 不允许“无父”的自由挂载（避免越权扩展设备树）。
	- 失败返回：`permission denied`、`parent required`、`parent not found` 等。

- 更新设备（PUT /devices/{id}）：
	- 非管理员必须首先“能控制目标设备”（三来源任一：管理员节点/设备默认/所有权）。
	- 非管理员限制：
		- 不得将 `OwnerUserID` 改为他人；
		- 如修改 `ParentID`，必须对“新父设备”具备控制权（与创建时相同）；
		- 其他字段（如 `Name`、`Role`）可在上述前提下更新（可按需进一步限制 `Role` 只有管理员能改）。

- 删除设备（DELETE /devices/{id}）：
	- 允许管理员删除；
	- 允许设备所有者删除“自己的设备”；
	- 单纯的“祖先设备”关系不足以删除他人拥有的设备（安全起见已收紧）。

示例请求（管理 API 经过 Manager 代理；字段名保持与数据模型一致）：
```json
// 创建设备（非管理员，必须提供 ParentID；Owner 省略则默认为自己）
{
	"HardwareID": "node-001",
	"Name": "Sensor A",
	"Role": "node",
	"ParentID": 12
}

// 更新设备（修改父节点，需能控制新父）
{
	"ID": 34,
	"ParentID": 12,
	"Name": "Renamed"
}

// 删除设备（所有者或管理员）
{
	"id": 34
}
```

### 8.3 变量池
- GET /variables?deviceId=...（var.read.{id}.* 或隐式允许）
- POST /variables（var.add.{id}.[name] 或隐式允许）
- PUT /variables（var.update.{id}.[name] 或隐式允许）
- DELETE /variables（var.remove.{id}.[name] 或隐式允许）

### 8.4 密钥与借用（授权）
- POST /keys（key.create；请求的节点集合必须为签发者有效权限的子集）
- GET /keys（key.read.*；管理员需 `admin.manage` 可查看所有，普通用户仅看自己签发/拥有）
- POST /keys/{id}/revoke（key.revoke.{id} 或 `admin.manage`）
- POST /devices/{id}/install-key（需对该设备具备管理权或所有权）
- POST /grants（grant.create；scope_nodes ⊆ 自身有效权限）
- DELETE /grants/{id}（grant.revoke.{id} 或 `admin.manage`）

### 8.5 登录/会话（Manager 登录本质为生成密钥）
- POST /auth/login -> 返回“会话密钥”（绑定 user，包含其有效权限或投影）。
- POST /auth/refresh -> 刷新会话密钥。
- POST /auth/logout -> 使当前会话密钥失效。
Manager 前端持有该会话密钥调用后续 API；服务端在管理操作处统一校验 `admin.manage`。

## 9. Manager 前端行为约束

- 无管理员标记（或无 `admin.manage`）的用户：
	- 仅显示其“拥有权”的设备及对应变量。
	- 隐藏“日志/用户管理/系统设置”。
- 具备 `admin.manage` 的用户：
	- 展示全量全局管理能力（用户管理、日志、全设备与变量）。

UI 技术点：登录成功后将会话密钥放入状态管理；路由守卫与菜单渲染依赖权限快照（由 /me 或 /auth/session 返回）。

## 10. 通配符匹配与性能

- 匹配：将节点按段切分；`*` 匹配单段，`**` 匹配余段；采用最短优先或从具体到泛化的顺序都可（推荐直接“任一匹配即允许”）。
- 加速：
	- 对每个主体维护权限集合缓存（含隐式展开结果），引入版本号或 TTL；关键变更后失效。
	- 可选用前缀树(Trie)或按首段建索引；规模小时列表匹配即可。

## 11. 撤销、过期与并发

- 撤销：设置 key.revoked=true 即刻生效；服务端缓存即时失效。
- 过期：校验 `expires_at`；过期即拒绝。
- 限次：在成功授权的操作上扣减 `remaining_uses`；使用数据库行级锁或乐观锁避免并发超用。

## 12. 审计与安全

- 审计：记录签发/撤销密钥、管理员标记变更、设备/变量删除、所有权迁移等。
- 安全：
	- 密钥仅存储哈希（或签名 JWT 的 jti + 队列黑名单）；
	- 最小权限原则：密钥/授予的节点集合不得超出签发者当前有效权限；
	- 管理操作强制要求 `admin.manage`。

## 13. 迁移计划

1) 新增表：users、permissions、keys、grants、audit_logs；为 devices 增加 owner_user_id 字段与索引。
2) 初始化：创建首个超级管理员用户，授予管理员标记 -> 注入 SystemAdminPolicy（含 `admin.manage`）。
3) 替换 ManagerToken：开发阶段保留配置后门；生产仅用登录会话密钥。
4) 接口接入：在 Server 统一中间件中实现鉴权与匹配；Manager API 逐步切换到权限判定。

## 14. 示例场景

- 设备拥有者 Alice 拥有设备 42：
	- 隐式：`var.*.42.*`、`device.update/remove/assignOwner.42`，对子树生效。
	- 可给 Bob 发授读密钥：`var.read.42.*`，有效期 7 天、最多 100 次。
- 管理员 Carol：
	- 具有管理员标记 -> 拥有 `admin.manage` 与 SystemAdminPolicy；
	- 可创建用户/移除用户、查看全部设备、读取日志。
- 设备 D7：
	- 隐式：对自身与子设备变量池的读写增删；无用户管理能力。

## 15. 需求映射（验收）

1) 用户 CRUD：提供用户表与 /users API（需 `admin.manage` + user.*）。
2) 设备添加可指定用户码：设置 owner_user_id -> 所有者隐式拥有对设备及变量的全部管理权与“借用”能力。
3) 默认设备拥有对自身及子设备变量池访问：DeviceSelfPolicy 已定义。
4) 用户可生成密钥并下发到设备：keys 模型 + API；支持到期与使用次数。
5) 用户与权限节点绑定、管理员标记：permissions 表 + admin 标记注入策略（含 `admin.manage`）。
6) Manager 登录 = 请求 server 生成会话密钥：/auth/login 返回会话密钥，后续凭密钥管理。
7) 具管理员标记者拥有全网管理：`admin.manage` + SystemAdminPolicy，能管用户与管理员标记。
8) 非管理员的 Manager 视图：仅显示拥有权设备与变量，隐藏日志与用户管理。
9) 密钥可随时撤销：/keys/{id}/revoke，立即生效，缓存失效。
10) 权限节点细节与通配符：已定义节点格式与 `*`/`**` 语义；所有权另行管理。

---

本设计与现有分层架构兼容：在 server/internal 层新增“鉴权中间件 + 权限查询与缓存 + 通配符匹配器”，manager 仅关心“登录/携带会话密钥/按权限裁剪 UI”。如需，我可以继续输出接口契约与最小实现步骤清单。

## 16. 默认管理员与首启规则（实现约定）

- 仅在“本次启动新建了数据库或 users 表”的情况下：
	- 自动创建默认管理员账户（用户名取自配置 `Server.DefaultAdmin.Username`，默认为 `admin`）。
	- 为该账户授予权限节点：`admin.manage` 与 `**`。
- 若用户表已存在：
	- 不创建默认管理员账户；也不自动赋予任何权限，避免干扰既有环境。
- 前端登录成功后会接收权限快照，并基于是否包含 `admin.manage` 控制管理员页面与全量数据访问。